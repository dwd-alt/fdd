<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My VPN Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ°Ô∏è</text></svg>">
</head>
<body>
    <div class="container">
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="alert" class="alert" style="display: none;"></div>

        <!-- –ó–∞–≥—Ä—É–∑—á–∏–∫ -->
        <div id="loader" class="loader" style="display: none;"></div>

        <header>
            <h1><i class="fas fa-shield-alt"></i> My VPN Dashboard</h1>
            <div class="status-indicator" id="statusIndicator">
                <span class="status-dot"></span>
                <span id="statusText">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
            </div>
        </header>

        <main>
            <div class="dashboard">
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ -->
                <div class="stats-card">
                    <h3><i class="fas fa-network-wired"></i> –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
                    <div class="stats-content">
                        <div class="stat-item">
                            <span class="stat-label">–°—Ç–∞—Ç—É—Å:</span>
                            <span class="stat-value" id="connectionStatus">–û—Ç–∫–ª—é—á–µ–Ω</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">–°–µ—Ä–≤–µ—Ä:</span>
                            <span class="stat-value" id="serverName">–ù–µ –≤—ã–±—Ä–∞–Ω</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">–í–∞—à IP:</span>
                            <span class="stat-value" id="ipAddress">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</span>
                            <span class="stat-value" id="uptime">00:00:00</span>
                        </div>
                    </div>
                </div>

                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ -->
                <div class="stats-card">
                    <h3><i class="fas fa-tachometer-alt"></i> –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞</h3>
                    <div class="stats-content">
                        <div class="stat-item">
                            <span class="stat-label"><i class="fas fa-upload"></i> –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</span>
                            <span class="stat-value" id="uploadStats">0 KB</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label"><i class="fas fa-download"></i> –ü–æ–ª—É—á–µ–Ω–æ:</span>
                            <span class="stat-value" id="downloadStats">0 KB</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label"><i class="fas fa-bolt"></i> –ú–µ—Ç–æ–¥:</span>
                            <span class="stat-value" id="method">-</span>
                        </div>
                    </div>
                </div>

                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="control-card">
                    <h3><i class="fas fa-server"></i> –í—ã–±–æ—Ä —Å–µ—Ä–≤–µ—Ä–∞</h3>
                    <div class="server-list" id="serverList">
                        <!-- –°–µ—Ä–≤–µ—Ä—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                    </div>

                    <div class="vpn-controls">
                        <button id="connectBtn" class="btn btn-connect">
                            <i class="fas fa-plug"></i> –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                        </button>
                        <button id="disconnectBtn" class="btn btn-disconnect" disabled>
                            <i class="fas fa-power-off"></i> –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è
                        </button>
                    </div>
                </div>

                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ -->
                <div class="config-card">
                    <h3><i class="fas fa-cog"></i> –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h3>
                    <button id="showConfigBtn" class="btn btn-config">
                        <i class="fas fa-qrcode"></i> WireGuard Config
                    </button>
                    <div id="configSection" style="display: none;">
                        <textarea id="configText" rows="8" readonly></textarea>
                        <div id="qrcode"></div>
                        <p style="text-align: center; margin-top: 10px; color: #666; font-size: 12px;">
                            –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≤ WireGuard –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
                        </p>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p><i class="fas fa-shield-alt"></i> My VPN Dashboard &copy; 2024 | –ó–∞—â–∏—â–µ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</p>
            <p style="font-size: 12px; opacity: 0.7; margin-top: 5px;">
                –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ä–µ–∂–∏–º. –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ VPN –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä.
            </p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <script>
        let currentStatus = null;
        let selectedServer = 'ssh-tunnel';
        let statusUpdateInterval;

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑—á–∏–∫
        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function formatUptime(startTime) {
            if (!startTime) return '00:00:00';

            const start = new Date(startTime);
            const now = new Date();
            const diff = Math.floor((now - start) / 1000);

            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const seconds = diff % 60;

            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        async function updateStatus() {
            try {
                const response = await fetch('/api/vpn/status');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');

                const data = await response.json();
                currentStatus = data;

                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                document.getElementById('connectionStatus').textContent =
                    data.connected ? '–ü–æ–¥–∫–ª—é—á–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω';
                document.getElementById('serverName').textContent =
                    data.server || '–ù–µ –≤—ã–±—Ä–∞–Ω';
                document.getElementById('ipAddress').textContent =
                    data.public_ip || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                document.getElementById('uploadStats').textContent =
                    data.upload || '0 B';
                document.getElementById('downloadStats').textContent =
                    data.download || '0 B';
                document.getElementById('method').textContent =
                    data.method || '-';
                document.getElementById('uptime').textContent =
                    formatUptime(data.start_time);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                const connectBtn = document.getElementById('connectBtn');
                const disconnectBtn = document.getElementById('disconnectBtn');

                if (data.connected) {
                    indicator.classList.add('connected');
                    statusText.textContent = '–ó–∞—â–∏—â–µ–Ω–æ';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                } else {
                    indicator.classList.remove('connected');
                    statusText.textContent = '–ù–µ –∑–∞—â–∏—â–µ–Ω–æ';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞', 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
        async function loadServers() {
            try {
                const response = await fetch('/api/servers');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');

                const data = await response.json();
                const serverList = document.getElementById('serverList');
                serverList.innerHTML = '';

                data.servers.forEach(server => {
                    const serverElement = document.createElement('div');
                    serverElement.className = 'server-item';
                    serverElement.innerHTML = `
                        <input type="radio" name="server" id="server_${server.id}"
                               value="${server.id}" ${selectedServer === server.id ? 'checked' : ''}>
                        <label for="server_${server.id}">
                            <strong>${server.name}</strong>
                            <span>${server.location} <span class="server-type">${server.type}</span></span>
                        </label>
                    `;

                    serverElement.querySelector('input').addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedServer = e.target.value;
                        }
                    });

                    serverList.appendChild(serverElement);
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤:', error);
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤', 'error');
            }
        }

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VPN
        document.getElementById('connectBtn').addEventListener('click', async () => {
            showLoader(true);

            try {
                const response = await fetch('/api/vpn/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ server: selectedServer })
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('VPN —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                    await updateStatus();
                } else {
                    showAlert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            } finally {
                showLoader(false);
            }
        });

        // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç VPN
        document.getElementById('disconnectBtn').addEventListener('click', async () => {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å—Å—è –æ—Ç VPN?')) return;

            showLoader(true);

            try {
                const response = await fetch('/api/vpn/disconnect', {
                    method: 'POST'
                });

                const data = await response.json();
                if (data.success) {
                    showAlert('VPN –æ—Ç–∫–ª—é—á–µ–Ω!');
                    await updateStatus();
                } else {
                    showAlert('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
            } finally {
                showLoader(false);
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥
        document.getElementById('showConfigBtn').addEventListener('click', async () => {
            const configSection = document.getElementById('configSection');
            if (configSection.style.display === 'none') {
                try {
                    const response = await fetch('/api/vpn/config');
                    const data = await response.json();

                    document.getElementById('configText').value = data.config;

                    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞
                    const qrcodeDiv = document.getElementById('qrcode');
                    qrcodeDiv.innerHTML = '';
                    QRCode.toCanvas(qrcodeDiv, data.config, {
                        width: 200,
                        margin: 1,
                        color: {
                            dark: '#2a5298',
                            light: '#ffffff'
                        }
                    }, function(error) {
                        if (error) {
                            console.error('QR Code error:', error);
                            qrcodeDiv.innerHTML = '<p style="color: #666;">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥</p>';
                        }
                    });

                    configSection.style.display = 'block';
                } catch (error) {
                    showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', 'error');
                }
            } else {
                configSection.style.display = 'none';
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            await Promise.all([updateStatus(), loadServers()]);

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            statusUpdateInterval = setInterval(updateStatus, 10000);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç—Ä–∞—Ñ–∏–∫–∞ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
            setInterval(() => {
                if (currentStatus && currentStatus.connected) {
                    // –ò–º–∏—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞
                    const upload = document.getElementById('uploadStats');
                    const download = document.getElementById('downloadStats');

                    if (upload && download) {
                        const currentUp = parseInt(upload.textContent) || 0;
                        const currentDown = parseInt(download.textContent) || 0;

                        upload.textContent = `${currentUp + Math.floor(Math.random() * 10)} KB`;
                        download.textContent = `${currentDown + Math.floor(Math.random() * 50)} KB`;
                    }
                }
            }, 3000);
        });

        // –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
            }
        });
    </script>
</body>
</html>